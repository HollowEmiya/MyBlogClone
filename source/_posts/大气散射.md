---
title: 大气散射
date: 2023-11-05
tags: 图形学
math: true
index_img: /imgs/大气散射/Res01.png
banner_img: /imgs/大气散射/Res02.png
typora-root-url: ../
---



# RayMarching:Atmospheric Scattering-RayleighScattering

## Rayleigh Scattering

一般的渲染都是在物体的一个表面上进行计算，而诸如半透明物体是光线和其内部结构相互作用造成的，还有比如皮肤的渲染，可以用 次表面散射去模拟这种效果。但是大气散射不是在表面上计算，是模拟光线透过大气会发生什么，也就是体积渲染。这里是学习 **体积单散射**，渲染实体半透明物体。
## Single Scattering
大多数游戏引擎的光线都是在真空传播，散射需要做的就是模拟光在空气介质中传播。
## Out Scattering & In Scattering
光和粒子最显著的现象就是粒子偏转光的方向，当一束光偏离 Camera 也就是外散射，偏离到 Camera 方向就是 **内散射**。

<img src="/imgs/大气散射/OutScattering.png">

## **Volumetric Signle Scattering**

实际上光可以反射/散射很多次，但是这需要大量计算，这里只是计算 **光的单次散射事件**。

关键在于如何模拟光线穿过大气。 即从 A 到 B 的光如何受到散射的影响，因为 AB 上任一点 P 都可能会发生散射。

![SingleScattering](/imgs/大气散射/SingleScattering.PNG)

所以在计算每个点 P 有多少 Out Scattering时，第一步要先知道 P点 有多少光。假设所有光都来自太阳，一些会发生 in-Scattering，转向摄像机:

![InScattering](/imgs/大气散射/InScattering.PNG)

内散射到 P，从 P 到 A 散射，能够描述大部分散射情况，但实际上 P 点接收的光，是太阳射向P并经过 CP 路径的 out-scattering后的。

![OutScattering2](/imgs/大气散射/OutScattering2.PNG)

## **[需要做的]可公开的情报**

- 摄像机的视线，从 A 出发，进入大气，并从 B 点离开。
- 我们需要考虑每个点 P∈AB 的 in-scattering 和 out-scattering 贡献/影响。
- P 点从太阳接收的光线
- P 点经路径CP接受光，收到 out-scattering 的影响
- P 点发生多少 in-scattering，使光线向相机方向。
- 从 P 射向摄像机的光受到 out-scattering 影响偏离相机的视线。

## **Transmittance Function**

要计算传播到 Camera 的有多少光，那么所有的计算应该在光线从太阳出发开始；

上图中光经过真空到达C点，其路径上没有其他物体影响，C点的光还没有散射； 设 C点的光量为 Ic，全部从太阳接收，从太阳真空传播过来，无散射影响。 经过路径CP，光线进入大气，和大气中的粒子发生散射，到达P的光量为 Ip(肯定小于Ic) 则 Ip和Ic的比率为 **transmittance**:

$$ T(\overline{CP})=\frac{I_P}{I_C} $$

![Trasmittance](/imgs/大气散射/Trasmittance.png)

 可以用 transmittance 表示在 CP 路径上为散射的光量百分比，也就是经过 CP 后能到得到的光量。这个函数我们后面会进行更详细的推导。

$$ I_P=I_CT(\overline{CP}) $$

## **Scattering Function**

假设我们先不考虑 **Transmittance Function** *T*，然后我们得到了 P点的光量，我们现在需要考虑的就是在P点有多少光因为 scattering 偏转到 camera 方向。 也就是 **Scattering Function** *S*，目的是描述某点处，有多少光沿某个角度发生偏转。

这里光的偏转角度为 θ，*S*(λ,θ,h) 的值表示沿theta偏转的光量比率。 受到波长，角度，高度的影响，高度是因为大气密度会随高度而改变。

$$ I_{PA}=I_P*S(\lambda,\theta,h)*T(\overline{PA})\\ I_{PA}=I_C*T(\overline{CP})*S(\lambda,\theta,h)*T(\overline{PA})\\ =\underbrace{ I_C*S(\lambda,\theta,h)}_{in-scattering}*\underbrace{T(\overline{CP})*T(\overline{PA})}_{out-scattering}\\ $$

![ScatteringFunc](/imgs/大气散射/ScatteringFunc.png)

S 计算折射到视线，T算的沿路径的损失，就是in-scattering 和 out-scattering

## **Numerical Integration**

看起来挺好，但可能你已经意识到了，这不太对吧，用 Ipa 表示 点P 传输到 A 的光量，但是刚才的公式并不能描述 A 所有接受到的光。 A接收的光应该是 P∈AB 所有点的累加贡献，我们应该计算 AB 上所有的点，这需要用到积分的思想，将AB划分为无数的微小段——ds，再进行累加，就是数值积分。

$$ I_A=\sum_{P\in\overline{AB}}I_{PA}ds $$

![NumericalIntegration](/imgs/大气散射/NumericalIntegration.png)

- 为什么要乘 ds 因为用 ds 中一个点 P0 代表所有这段上所有点的光线如何散射

> 假设不划分，以 E 为 AB 每个点的光照散射结果，那么 IA = E * dis_AB

## **Direcation Light**

如果离太阳近可以建模点光源解决，不过通常我们都离太阳很远，而且这里最终目的是做山麓之间的那种大气散射，所有还是以 direction light 建模。 因此每个点接收相同数量的光，且方向保持不变。

现在可以对 IC 进行简化。

$$ I_A=\sum_{P\in\overline{AB}}I_{PA}ds\\\ =\sum_{P\in\overline{AB}}I_C*S(\lambda,\theta,h)*T(\overline{CP})*T(\overline{PA})ds\\ =I_S\sum_{P\in\overline{AB}}S(\lambda,\theta,h)*T(\overline{CP})*T(\overline{PA})ds\\ $$

![DirectionLight](/imgs/大气散射/DirectionLight.png)

> 如果这里阳光和camera 都不动，theta 固定，甚至还可以优化

## **Absorption Coefficient**

> 在描述光和空气分子之间相互作用的可能结果时，我们只介绍了两个。直接通过，或偏转。还有第三种可能。一些化合物吸收光。地球上的大气中有很多具有这种特性的化学物质。例如，臭氧存在于高等大气中，并且已知对紫外线有强烈反应。然而，它的存在对天空的颜色几乎没有影响，因为它吸收了可见光谱之外的光。在地球上，吸光化学物质的贡献往往被忽视。 在地球上，吸光化学物质的贡献往往被忽视。其他行星不能这样做。例如，海王星和天王星的典型颜色是由大气中大量存在的甲烷引起的。甲烷以吸收红光而闻名，导致蓝色色调。在本教程的其余部分，我们将忽略吸收系数，尽管我们将添加一种为大气着色的方法。

## **Scattering Model**

模拟大气散射现象是十分复杂的，几乎没有一个完美的模型去描述。 通常使用两种模型 : **Rayleigh scattering** 和 **Mie scattering**. Rayleigh Scattering 描述光和微小粒子的散射，比如空气，氧、氮分子。 Mie Scattering 描述的是光的波长和粒子大小相近的散射情况，比如用 Mie scattering 画太阳，花粉、粉尘、污染物。

Rayleigh Scattering 导致天空是蓝的，日落是红的，Mie Scattering 导致云是白的。

## **Rayleigh Scattering**

需要明确的一点是 Rayleigh Scattering 只能描述粒子小于光的波长。 当光子撞击到粒子后，因为粒子足够小，主要有两部分光，一部分不受影响继续传播，一部分以相反方向反射回来，其他可能沿其他方向传播，不过因为光的方向导致其不太可能沿 90° 。

> 可以想象一个胖人去撞一个比较瘦的人，或者撞一根很细的柱子

![RayleighScattering](/imgs/大气散射/RayleighScattering.png)

其 **Rayleigh scattering equation**

$$ I=I_0S(\lambda,\theta,h)\\ S(\lambda,\theta,h)=\frac{\pi^2(n^2-1)^2}{2}\underbrace{\frac{\rho(h)}{N}}_{density}\overbrace{\frac{1}{\lambda^4}}^{wavelength}\underbrace{(1+\cos^2\theta)}_{geometry} $$

- λ: the **wavelength** of the incoming light;
- θ : the **scattering angle**;
- h : the **altitude** of the point;
- n=1.00029 : the **refractive index** of air;(空气的**折射率**)
- : the **molecular number density** of the standard atmosphere. This is the number of molecules per cubic metre;(标准大气的**分子数密度**。这是每立方米的分子数;)
- : the **density ratio**. This number is equal to 
-  at sea level, and decreases exponentially with 
- . There is a lot to say about this function, and we will do it in a future post of this series.(**密度比**。 此数字等于海平面1时的数字，后面细嗦)

该方程来自：[nishitalab.org/user/nis/cdrom/sig93_nis.pdf](http://nishitalab.org/user/nis/cdrom/sig93_nis.pdf)

![chart](/imgs/大气散射/chart.png)

- 某些方向比其他方向接收更多光
- 散射的光量多少受光波长的影响，波长越长越少，红少蓝多(所以天是蓝的)

## **Rayleigh Scattering Coefficient**

前面的Rayleigh 只描述了散射的方向，但是没有描述某一点散射现象的能量衰减。要考虑能量的损失，我们得考虑各个方向上的光能的散射。 很简单对相位函数做积分即可，不过记得这是一个三维空间，不是二维的可别在 [0,2pi] 积分。

$$ \beta(\lambda,h)=\int_0^{2\pi}\int_0^\pi S(\lambda,\theta,h)\sin\theta d\theta d\phi\\ =\int_0^{2\pi}\int_0^\pi\frac{\pi^2(n^2-1)^2}{2}\frac{\rho(h)}{N}\frac{1}{\lambda^4}(1+\cos^2\theta)\sin\theta d\theta d\phi\\  =\frac{\pi^2(n^2-1)^2}{2}\frac{\rho(h)}{N}\frac{1}{\lambda^4}\int_0^{2\pi}\int_0^\pi(1+\cos^2\theta)\sin\theta d\theta d\phi\\  =\frac{\pi^2(n^2-1)^2}{2}\frac{\rho(h)}{N}\frac{1}{\lambda^4}\int_0^{2\pi}\int_0^\pi(\sin\theta+\sin\theta\cos^2\theta) d\theta d\phi\\  =\frac{\pi^2(n^2-1)^2}{2}\frac{\rho(h)}{N}\frac{1}{\lambda^4}\int_0^{2\pi}(\cos0+\frac{\cos0}{3}-\cos\pi-\frac{\cos^3\pi}{3})d\phi\\ =\frac{\pi^2(n^2-1)^2}{2}\frac{\rho(h)}{N}\frac{1}{\lambda^4}\int_0^{2\pi}\frac{8\pi}{3}d\phi\\ =\frac{\pi^2(n^2-1)^2}{2}\frac{\rho(h)}{N}\frac{1}{\lambda^4}\frac{16\pi}{3}\\ =\frac{8\pi^3(n^2-1)^2}{3}\frac{\rho(h)}{N}\frac{1}{\lambda^4}\\ \\  \beta(\lambda,h)  =\frac{8\pi^3(n^2-1)^2}{3}\frac{\rho(h)}{N}\frac{1}{\lambda^4}\\$$

所以能量的散射受波长和海拔高度的影响。

![chart2](/imgs/大气散射/chart2.png)

所以地球大气分子会更多反射蓝光，所以当傍晚时，光线要经过更多大气，传播时间更长，所有的蓝光基本都被散射，我们观察到的就是红色的天空。 而白天天空为什么是蓝色的，首先，白天我们观察时日光方向基本固定，因为蓝色更容易发生散射，在空中蓝色光波被散射到四面八方，我们观察天空接收到的自然也就是蓝光。

## **Rayleigh Phase Function**

关于 Rayleigh Scattering Equation 可以分解为两个部分，一部分是 Rayleig Scattering Coefficient，也就是刚刚推导的；另一部分是 Geometry of Scattering，并控制其反射方向。 

$$ S(\lambda,\theta,h)=\beta(\lambda,h)\gamma(\theta)\\ \gamma(\theta)=\frac{S(\lambda,\theta,h)}{\beta(\lambda,h)}=\\ \frac{\pi^2(n^2-1)^2}{2}\frac{\rho(h)}{N}\frac{1}{\lambda^4}(1+\cos^2\theta)\frac{3}{8\pi^3(n^2-1)^2}\frac{N}{\rho(h)}\lambda^4=\\ \frac{3}{16\pi}(1+\cos^2\theta) $$

## **[可公开的情报]**

- **Rayleigh Scattering Equation** 描述在某方向的光偏转比率

$$ S(\lambda,\theta,h)=\frac{\pi^2(n^2-1)^2}{2}\frac{\rho(h)}{N}\frac{1}{\lambda^4}(1+\cos^2\theta)\\ S(\lambda,\theta,h)=\beta(\lambda,h)\gamma(\theta) $$

- **Rayleigh Scattering Coefficient** 在某点发生散射后，多少比例的能量损失情况

$$ \beta(\lambda,h)=\frac{8\pi^3(n^2-1)^2}{3}\frac{\rho(h)}{N}\frac{1}{\lambda^4}\\ $$

- **Rayleigh Scattering Coefficient in Sea level**
- $$ \beta(\lambda,0)=\frac{8\pi^3(n^2-1)^2}{3}\frac{1}{N}\frac{1}{\lambda^4}\\ $$

- **Rayleigh Scattering Phase Function** 描述散射的形状，在特定方向光的损失相对比率。
- $$ \gamma(\theta)=\frac{3}{16\pi}(1+\cos^2\theta) $$

- **Density ratio** 模拟大气密度的函数
- $$ \rho(h)=\exp(\frac{h}{H}) $$

H = 8500 是 scale heigh

## **Atmospheric Density Ratio**

当大气密度越大时大气中粒子越多，会有更多的散射现象发生。 大气密度和高度示意图：

![height](/imgs/大气散射/height.png)

H 为 Scale Height，通常取 8500

## **Exponential Decay**

我们前面的得到了 **scattering coefficient** *β*，我们有能求得解析解的 close form 函数

$$ \beta(\lambda,h)=\frac{8\pi^3(n^2-1)^2}{3}\frac{\rho(h)}{N}\frac{1}{\lambda^4}\\ $$

上式描述了**光和粒子单次散射后**光量损失的比例。

现在假设如果初始光量为 I0，然后以衰减系数为β，经过大气中粒子的一次散射后所剩的光量会是：**(这里的β不是*****β(λ,h)*****,而是鉴定穿过一部分大气后的衰减系数)**

$$ I_1=\underbrace{I_0}_{initial\;energy}-\underbrace{I_0\beta}_{energy\;lost}=(1-\beta)I_0 $$

但这只适用于一次散射/单次散射碰撞，我们希望求得**在一均匀介质中**，传播一定距离后光的衰减： 假设我们将这个过程分为两次散射看待，考虑两次散射：**(这里的β不是*****β(λ,h)*****,而是鉴定穿过一部分大气后的衰减系数)**

$$ First\;Scattering\;:\;I_1=I_0(1-\beta\frac{S}{2})\\ Second\;Scattering\;:\;I_2=I_1(1-\beta\frac{S}{2})=I_0(1-\beta\frac{S}{2})^2\\ About\;N\;Scattering\;:\;I=\lim_{n\rightarrow\infty}I_0(1-\beta\frac{S}{n})^n=\exp\{-\beta S\} $$

## **Uniform Transmittance**

**transmittance** T 描述了光量穿越大气时经过散射所剩余的光量比例。

![OutScattering2](/imgs/大气散射/OutScattering2.PNG)

根据刚才的欧拉数推导我们能写出一个 P位置光量

$$ I_P=I_S\exp\{-\beta\overline{CP}\}\\ \overline{CP}:\;distance \; of \; CP $$

但实际上CP中的散射系数β不是一个均匀值 我们延续前面类似的思路，将CP分为两段CQ，QP

![Trasmittance2](/imgs/大气散射/Trasmittance2.png)

$$ I_Q=I_S\exp\{-\beta(\lambda,h_0)\overline{CQ}\}\\ I_P=I_Q\exp\{-\beta(\lambda,h_1)\overline{QP}\}\\ I_P=I_S\exp\{-\beta(\lambda,h_0)\overline{CQ}\}\exp\{-\beta(\lambda,h_1)\overline{QP}\}\\ I_P=I_S\exp\{-\beta(\lambda,h_0)\overline{CQ}-\beta(\lambda,h_1)\overline{QP}\} $$

如果CQ和QP长度相同还可以再次简化，那不妨设其相同且为 ***ds*** (方便后面采用积分思想推导)

$$ I_P=I_S\exp\{-(\beta(\lambda,h_0)+\beta(\lambda,h_1))ds\} $$

延续该思路我们可以将 CP 段化为无数等长的小段，累加这个过程,也就是数值积分

$$ I_P=I_S\exp\{-\sum_{Q\in\overline{CP}}\beta(\lambda,h_Q)ds\} $$

将 Rayleigh Scattering 带入

$$ T(\overline{CP})=I_S\exp\{-\sum_{Q\in\overline{CP}}\frac{8\pi^3(n^2-1)^2}{3}\frac{\rho(h_Q)}{N}\frac{1}{\lambda^4}ds\}\\ =\underbrace{-\frac{8\pi^3(n^2-1)^2}{3}\frac{1}{N}\frac{1}{\lambda^4}}_{constant\;\beta(\lambda)}\overbrace{\sum_{Q\in\overline{CP}}\rho(h_Q)ds}^{optical\;depth\;D(\overline{CP})}\\ $$

求和部分为 Optical Depth ，需要我们在 shader 中计算，其他都是常数。

$$ T(\overline{CP})=\exp\{-\beta(\lambda)D(\overline{CP})\} $$

## **Intersecting the Atmosphere**

> 这个教程是渲染星球的

所以其要求 AB 的 optical depth，其中 O 点是大气层表面一点也就是我们的 fragment

![math](/imgs/大气散射/math.png)

D 是 camera 的视线方向，L外壳半径，R大气半径

$$ A=O+D\overline{OA}\\ B=O+D\overline{OB}\\ \overline{OA}=\overline{OT}-\overline{AT}\\ \overline{OB}=\overline{OT}+\overline{TB}\\ \overline{AT}=\overline{TB}\\ \overline{OT}=(C-O)\cdot D=L\cdot D\\ R^2=(\overline{CT})^2+(\overline{AT})^2\\ (\overline{CT})^2=L^2-(\overline{OT})^2\\ (\overline{AT})^2=R^2-(\overline{CT})^2 $$

如果 CT 大于 R 则无解

### **Colliding with the Planet**

和 plant 相交 只需要按和大气球求交点再求一次和plant球的交点即可 如果有解则 大气的 B点要改为 plant 的A点

![math2](/imgs/大气散射/math2.png)

## **Sampling the View Ray**

$$ I=I_S\sum_{P\in AB}S(\lambda,\theta,h)T(\overline{CP})T(\overline{PA})ds\\\\ Decompose \;S(\lambda,\theta,h):\\ S(\lambda,\theta,h)=\beta(\lambda,h)\gamma(\theta)=\beta(\lambda)\rho(h)\gamma(\theta)\\ \beta(\lambda)=\frac{8\pi^3(n^2-1)^2}{3N\lambda^4}\\ \rho(h)=\exp\{-\frac{h}{H}\}\\ \gamma(\theta)=\frac{3}{16\pi}(1+\cos^2(\theta))\\ We\;get:I=I_S\beta(\lambda)\gamma(\theta)\sum_{P\in AB}\underbrace{T(\overline{CP})T(\overline{PA})\rho(h_P)ds}_{light\;contribution\;of\;L(P)}\\ $$

$$ For\;T(\overline{Dis}):\\ T(\overline{CP})T(\overline{PA})=\exp\{-\beta(\lambda)D(\overline{CP})\}\exp\{-\beta(\lambda)D(\overline{PA})\}\\ =\exp\{-\beta(\lambda)(D(\overline{CP})+D(\overline{PA}))\}\\ D(\overline{CP})=\sum_{Q\in CP}\exp\{-\frac{h_Q}{H}\}dt\\ D(\overline{PA})=\sum_{Q\in AP}\exp\{-\frac{h_P}{H}\}dx\\\\ I=I_S\beta(\lambda)\gamma(\theta)\sum_{P\in AB}\underbrace{T(\overline{CP})T(\overline{PA})\rho(h)ds}_{light\;contribution\;of\;L(P)}\\ $$

$$ \sum_{P\in AB}T(\overline{CP})T(\overline{PA})\rho(h_P)ds=\sum_{P\in AB}\rho(h_P)\exp\{-\beta(\lambda)(D(\overline{CP})+D(\overline{PA}))\}ds\\ 实际上 D(\overline{PA}) 可以在最外层循环\sum_{P\in AB}做累加,\\ 不必每次在里面的循环做，即不必每次从A开始累加 $$

## **[To Do]Mie Scattering**

和波长无关，只和粒子大小相干

$$ phase\;function:\\ S(\theta)= \frac{1}{4\pi}\frac{3(1-g^2)}{(1-2g\cos\theta+g^2)^{\frac{3}{2}}}\\ or:S(\theta)=\frac{3}{8\pi}\frac{1-g^2}{2+g^2}\frac{1+\cos^2\theta}{(1-2g\cos\theta+g^2)^{\frac{3}{2}}} $$

# 待更新

我们知道了基本的计算思路，但是实际实现还有所不同，后面陆续更新