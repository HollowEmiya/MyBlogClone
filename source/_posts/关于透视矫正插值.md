---
title: 关于透视矫正插值
tags: 图形学
math: true
index_img: /imgs/Hexo主题变更/Shiki&Tsukihime.png
banner_img: /imgs/Hexo主题变更/Shiki&Tsukihime.png
date: 2024-04-14 15:35:04
typora-root-url: ../
---

把之前推导计算的透视矫正插值记录一下

<!--more-->

# 透视矫正插值

首先我们要知道从 “**顶点着色器**” 到 “**片元着色器**” 需要经过 “**光栅化(Rasterization)**”
而光栅化做的就是把三角形离散为一个一个片元，
如果是对于一个三角形而言，我们能够通过重心坐标表示其中任意一点。

## 重心坐标

设有三角形 ABC，及内一点P

所谓重心坐标就是，三角形内一点可以写作
$$
P=\alpha A+\beta B+\gamma C
$$
如果 $(\alpha + \beta+\gamma)==1$ 则点 **P** 在三角形内。

* 为什么能用重心坐标表示一个点?

* 因为假设一个点P在一条直线上，取直线上两点 AB，
  P点的位置一定能由 $P=\alpha A+\beta B$ 表示，并且$\alpha+\beta==1$则 P 在 AB 之间。
  而 三角形重心坐标 可以看作 先在 AB上寻找一点 $D=\alpha_1 A+\beta_1 B$, 而 点P 在线 CD 上，有 $P = \alpha_2D+\gamma C$.

### 屏幕坐标和NDC空间坐标

如何从 MVP 的 Vertex 到 ScreenPos

NDC 是GPU为了方便图像处理的空间，x->[0,1] y->[0,1] z->[-1,1]/[0,1]
xy是线性变化，其实还好，问题关键在于z

### MVP 变换

M 是 Object 自己的变化

V 是 camra forwardVec 和 UpVec，推导 rightVec，根据正交矩阵性质，转置就是其逆

P 是 View 到 ClipSpace， ClipSpace 后再经过齐次除法到 NDC 空间。

再NDC空间后再进行光栅化。

#### Projection Matrix

$$
\begin{bmatrix}
\frac{near}{wid}&0&0&0\\
0&\frac{near}{height}&0&0\\
0&0&\frac{far}{near-far}&\frac{near\cdot far}{near-far}\\
0&0&1&0\\
\end{bmatrix}
$$

其实矩阵变换是线性的，问题在于后面的齐次除法

## Screen 插值

我们首先要保证的是 Screen 上的点插值是正确的  
因为我们只会对顶点进行齐次除法，而我们对于点P进行重心坐标插值时，三角形ABC都是经过齐次除法的，这没有问题，但是顶点中其他数据比如UV这种是没有经过齐次除法的。  
所以根据屏幕点P的重心坐标，求经过矫正的插值：

$$
\begin{aligned}
	&设屏幕上三角形点A_s、B_s、C_s\\
	&屏幕上三角形内一点P_s\\
	&对于点XY坐标而言有：\\
	&P_s = \alpha A_s+\beta B_s+\gamma C_s\\
	&因为屏幕空间的点都是经过齐次除法的，且 Z 值是能够从[0,1]反向计算得到的\\
	&\frac{P_p}{z_P}= \alpha \frac{A_p}{z_A}+\beta \frac{B_p}{z_B}+\gamma \frac{C_p}{z_C}\\\\
	& \textbf{我们已知} A_s、B_s、C_s和点P_s;\\\\
	&也就是说P_s是Clip\;Space的P_p投影变换得到\\
	&P_p =z_p( \alpha \frac{A_p}{z_A}+\beta \frac{B_p}{z_B}+\gamma \frac{C_p}{z_C})
	\\
	&且P_p,P_s \;都在\; \triangle ABC内\\
	& \alpha+\beta+\gamma=1\\
	&z_p( \frac{\alpha}{z_A}+\frac{\beta}{z_B}+\frac{\gamma }{z_C})=1\\
\end{aligned}
$$

所以能得到根据矫正插值和屏幕XY坐标计算的插值关系

$$
\begin{aligned}
	&\frac{z_p\alpha}{z_A}=\alpha_p,\;\frac{z_p\beta}{z_B}=\beta_p,
	\frac{z_p\gamma}{z_C}=\gamma_p\\
	&P_p=\alpha_pA_p+\beta_pB_p+\gamma_pC_p\\
	&但是z_p是未知的\\
	&\frac{\alpha_p}{\beta_p}=\frac{\alpha z_B}{\beta z_A}\\
	&得\;\;\alpha_p=\frac{\alpha z_B}{\beta z_A}\beta_p\\
	&所以\;\;\gamma_p=\frac{\gamma z_B}{\beta z_C}\beta_p\\
	&(\frac{\alpha z_B}{\beta z_A}+\frac{\gamma z_B}{\beta z_C}+1)\beta_p=1\\
\end{aligned}
$$

能够得到透视矫正插值

$$
\begin{aligned}
(\frac{\alpha z_Bz_C+\gamma z_Az_B + \beta z_Az_C}{\beta z_Az_C})\beta_p=1\\
\beta_p=\frac{\beta z_Az_C}{\alpha z_Bz_C+\gamma z_Az_B + \beta z_Az_C}\\
\alpha_p=\frac{\alpha z_Bz_C}{\alpha z_Bz_C+\gamma z_Az_B + \beta z_Az_C}\\
\gamma_p=\frac{\gamma z_Az_B}{\alpha z_Bz_C+\gamma z_Az_B + \beta z_Az_C}\\
\end{aligned}
$$

对于 屏幕点P，我们知道其 XY 坐标，但是不知道该点在 Clip Space的实际位置，所以对于 顶点内数据都要进行透视矫正插值。

## 参考

[Latex 多行公式](https://matnoble.github.io/tech/latex/multi-line-equations/)
