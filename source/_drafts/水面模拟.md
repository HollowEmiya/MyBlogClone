---
title: Unity FFT 水面模拟
math: true
tags: 图形学, unity
index_img: /imgs/Hexo主题变更/Shiki&Tsukihime.png
banner_img: /imgs/水面模拟/InterstellarSeaWave.png
date: 2024-05-01
typora-root-url: ../
---

Unity 水面模拟

# 浪

[海浪01](https://www.bilibili.com/video/BV18v4y1P7Ne)  
[海浪02](https://www.bilibili.com/video/BV1u7411K7MR)
[星际穿越实拍海浪](https://www.bilibili.com/video/BV1U54y1C7YG)  
![InterstellarSeaWave](/imgs/水面模拟/InterstellarSeaWave.png)

# GPU 精粹 波相关

我说实话翻译版真的是太抽象了……

## 1.2 正弦波

首先对于波的模拟有两个部分，一个是网格的几何波动(顶点偏移)，另一个就是网格上法线的扰动。
主要是用周期波叠加实现，先看简单的正弦函数。

这里主要在数学定义上了解波的模拟

### 1.2.1 波的选择

 需要一个参数组来定义波，如下

* 波长($L$) : 世界空间中波峰之间的距离。波长 $L$ 和 角频率 $\omega$ 的关系为 $\omega =2\pi/L$
  这里的角频率就是平时我们说的频率
* 振幅($A$) : 水平面到波峰的距离，决定了波的高低。
* 速度($S$) : 因为波是会动的，表示每秒钟波的移动距离。通常表示为常数项 $\phi=S*2\pi/L$
* 方向($D$) : 垂直于波阵面的水平向量。
  所谓波阵面是指波峰沿着它运动的面，比如 y=sin(x)，D=(1,0)。

波的状态定义为水平位置 (x, y) 和 时间 (t) 的函数：
$$
\begin{aligned}
	W_i(x,y,t)=A_i*\sin(D_i\cdot(x,y)*\omega_i+t*\phi_i)
\end{aligned}
$$


我们可以用多个波叠加模拟总表面
$$
\begin{aligned}
	H(x,y,t)=\sum(A_i*\sin(D_i\cdot(x,y)*\omega_i+t*\phi_i))
\end{aligned}
$$

![waveparameters](/imgs/水面模拟/waveparameters.png)

### 1.2.2 法线和切线

因为我们上面用正弦函数表示波，所以是一个显式函数，也就是说能在任意给定点直接计算表面方向，不用使用差分算法计算。
副法线 $B$ 和 切线 $T$ 向量分别为 $x$ 和 $y$ 方向的偏导数。对在 2D 水平面中的任何点 $(x, y)$​，其在表面的三维位置是( 3D 空间表示 )：
$$
\begin{aligned}
	P(x,y,t)=(x,y,H(x,y,t))
\end{aligned}
$$
对于副法线 $x$ 的偏导是 : 
$$
\begin{aligned}
	B(x,y)=[\frac{\delta x}{\delta x},\frac{\delta y}{\delta x},
	\frac{\delta }{\delta x}(H(x,y,t))]\\
	B(x,y)=(1,0,\frac{\delta }{\delta x}(H(x,y,t)))
\end{aligned}
$$
同理切线为：
$$
\begin{aligned}
	T(x,y)=[\frac{\delta x}{\delta y},\frac{\delta y}{\delta y},
	\frac{\delta }{\delta y}(H(x,y,t))]\\
	T(x,y)=(0,1,\frac{\delta }{\delta y}(H(x,y,t)))
\end{aligned}
$$
法线由 $B,T$ 叉乘得到：
$$
\begin{aligned}
	N(x,y)=B(x,y)\times T(x,y)\\
	N(x,y)=[-\frac{\delta}{\delta x}(H(x,y,t)),-\frac{\delta}{\delta y}(H(x,y,t)),1]
\end{aligned}
$$
计算偏导(以 对x求偏导为例)：
$$
\begin{aligned}
	\frac{\delta}{\delta x}(H(x,y,t))&=\sum[\frac{\delta}{\delta x}(W_i(x,y,t))]\\
	&=\sum(\omega_i*D_i.x*A_i*\cos(D_i\cdot(x,y)*\omega_i+t*\phi_i))
\end{aligned}
$$
但是这样单纯叠加的波缺少真实感，真实的波波峰是尖的，而波谷会更宽。
这里将正弦函数修改为非负状态，并赋予指数k。
$$
\begin{aligned}
	W_i(x,y,t)=&2A_i*[\frac{\sin(D_i\cdot(x,y)*\omega_i+t*\phi_i)+1}{2}]^k\\
	\frac{\delta}{\delta x}(W_i(x,y,t))=&k*D_i.x*\omega_i*A_i[\frac{\sin(D_i\cdot(x,y)*\omega_i+t*\phi_i)+1}{2}]^{k-1}\\
	&*\cos(D_i\cdot(x,y)*\omega_i+t*\phi_i)
\end{aligned}
$$
![kWave](/imgs/水面模拟/kWave.png)

### 1.2.3 几何波

#### 方向波或圆形波

对于方向波，每个 $D_i$ 都是波寿命常数，其实就是*常数*。  
对于圆形波，方向必须在每个顶点计算，它是从波中心到顶点的规范化向量：
$$
D_i(x,y)=[\frac{(x,y)-C_i}{|(x,y)-C_i|}]
$$
大水体一般用方向波比如海洋。  
小水体一般用圆形波比如池塘。

#### Gerstner 波

正弦波还是太圆润，Gerstner 波能够模拟浪头更尖锐的波
$$
\begin{aligned}
	P(x,y,t)=
	\left\{\begin{array}{}
	x+\sum(Q_iA_i*D_i.x*\cos(\omega_iD_i\cdot(x,y)+\phi_it))\\
	y+\sum(Q_iA_i*D_i.y*\cos(\omega_iD_i\cdot(x,y)+\phi_it))\\
	\sum(A_i\sin(\omega_iD_i\cdot(x,y)+\phi_it))
	\end{array}
	\right.
\end{aligned}
$$
$Q_i$ 是控制波陡度的参数，如果 $Q_i=0$ 就是正常的叠加正弦波，而 $Q_i=1$ 是尖峰的波形。  
但是如果 $Q_i$​ 过大会导致波形成环，这点需要注意。

法线切线也有变化：
$$
\begin{aligned}
	&WA=\omega_i*A_i\\
	&S()=\sin(\omega_i*D_i\cdot P+\phi_it)\\
	&C()=cos(\omega_i*D_i\cdot P+\phi_it)\\
	&B=\left\{
		\begin{array}{}
		1-\sum(Q_i*D_i.x^2*WA*S())\\
		-\sum(Q_i*D_i.x*D_i.y*WA*S())\\
		\sum(D_i.y*WA*C())
		\end{array}
	\right.\\
	&T=
	\left\{
		\begin{array}{}
			-\sum(Q_i*D_i.x*D_i.y*WA*S())\\
			1-\sum(Q_i*D_i.y^2*WA*S())\\
			\sum(D_i.y*WA*C())
		\end{array}
	\right.
\end{aligned}
$$

# FFT 海洋

这部分内容都是抄的：[【学习笔记】Unity 基于GPU FFT海洋的实现-理论篇 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/95482541)

>离散傅里叶变换(Discrete Fourier Transform, DFT)  
>逆离散傅里叶变换(Inverse Discrete Fourier Transform, IDFT)

DFT 的公式，如果$f(x)$ 为一个长度为 $N$ 的数字序列，则其 DFT $f(\mu)$ 为
$$
\begin{aligned}
	\textstyle F(\mu)=\sum^{N-1}_{x=0}f(x)e^{-i\frac{2\pi\mu x}{N}}
\end{aligned}
$$

* $F(\mu)$ 为转换后的**频域函数**。  
* $\mu$​ 是频率。
  DFT 做的就是把时域函数中一个复杂的波形展开为多个正弦波。
* $f(x)$​ 是时域函数
* $e^{-i\frac{2\pi\mu x}{N}}$​ 是一个复数
  利用欧拉公式：$e^{ix}=\cos(x)+i\sin(x)$

$$
\begin{aligned}
	F(\mu)=\textstyle \sum^{N-1}_{x=0}f(x)\cos(\frac{2\pi\mu x}{N})-i\sum^{N-1}_{x=0}f(x)\sin(\frac{2\pi\mu x}{N})
\end{aligned}
$$

逆傅里叶变换 IDFT
$$
\begin{aligned}
	f(x)=\frac{1}{N}\textstyle\sum^{N-1}_{\mu=0}F(\mu)e^{i\frac{2\pi\mu x}{N}}
\end{aligned}
$$

## FFT 海洋公式

如果我们需要一个复杂的海面，可以生产一个频谱( 也就是在频域 pick 多个函数 )，然后通过 IDFT 就能够得到 由多个不同频率、振幅的波 叠加的复杂海面。  
这样频谱决定了海面形状。

### Simulating Ocean Water-Jerry Tessendorf

这里还需要再研究一下这个paper……

Simulating Ocean Water-Jerry Tessendorf 的海洋公式：
$$
\begin{aligned}
	h(\vec{x},t)=\textstyle\sum_k\tilde{h}(\vec{k},t)e^{i\vec{k}\cdot\vec{x}}
\end{aligned}
$$
这个其实就是逆离散傅里叶变换变换的形式。

其中参数 $\vec{x}=(x,z)$ 是水平方向的坐标，$t$ 是时间，函数 $h$ 可以返回在时间 $t$ , $\vec{x}$ 处的海面高度。   
$\vec{k}$ 为波矢量，$\vec{k}=(k_x,k_z)=(\frac{2\pi n}{L_x},\frac{2\pi m}{L_z})$
$$
\begin{aligned}
	-\frac{N}{2}\le n < \frac{N}{2}\\
	-\frac{M}{2}\le m < \frac{M}{2}
\end{aligned}
$$
$\vec{k}$ 为波矢量，$L_x$ 和 $L_y$ 是海平面的大小，$N$ 和 $M$ 是采样离散点的数量。  
如果 $N$ 和 $M$ 越大波就越精细，叠加的波就更多，但是计算时间也会增加。

所以现在需要计算出频谱，然后按照 $h(\vec{x},t)$ 函数就可以得到海面的高度，  
现在观察 频谱函数 $\tilde{h}(\vec{k},t)$  
$\tilde{h}(\vec{k},t)=\tilde{h_0}(\vec{k})e^{i\omega(k)t}+\tilde{h_0^*}(-\vec{k})e^{-i\omega(k)t}$  
$\tilde{h^*_0}$ 是 $\tilde{h_0}$ 的共轭复数，$k$ 是 $\vec{k}$​ 的模。

#### From Simulating Ocean Water : 4.2  AnimatingWaves:TheDispersionRelation

$\omega(k)$ 是 角频率 $\omega$ 和 波长 $k$ 的 弥散函数。

* 在深水区，关系为 $\omega^2(k)=gk$  
  $g=9.8m/{sec}^2$ 是重力参数
* 当水较浅的时候，底部对波浪有延缓作用，对于在平均水位以下深度为 $D$ 处的底部，弥散关系为：  
  $\omega^2(k)=gk\tanh(kD)$​  
  [双曲正切函数（Tanh函数） - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/520861532)
* 除了水的深度外，表面张力也有影响，波长为 1cm 或者 更短的非常小的波 有附加项：  
  $\omega^2(k)=gk(1+k^2L^2)$  
  参数 $L$ 是标准长度，其大小是对表面张力有影响的尺度。

#### From Simulating Ocean Water : 4.4  BuildingaRandomOceanWaveHeightField

> 水波高度是由目前所述的原理模拟的：具有规定形式的空间谱的高斯随机数。  
> 对于傅里叶域这是非常有效的。波高场的傅里叶振幅可以被表示为：

$\tilde{h}_0(\vec{k})=\frac{1}{\sqrt{2}}(\xi_r+i\xi_i)\sqrt{P_h(\vec{k})}$

$\xi_r$ 和 $\xi_i$ 为来自 *高斯随机数生成器*的普通独立随机数，均值为 0，标准差为 1.

$P_h(\vec{k})$ 是我们的方向波谱，方向波谱一般描述为 $S(\omega,\theta)$ ,这和我们前面的参数不太一样，其实他们之间可以相互转换，有兴趣可以看**Empirical Directional Wave Spectra for Computer Graphics**这篇论文。(暂时没找到这篇paper的资源，就没看)  
方向波谱  $S(\omega,\theta)$ 是非定向波谱 $S(\omega)$ 和方向拓展函数 $D(\omega,\theta)$ 的乘积.   
$S(\omega,\theta)=S(\omega)D(\omega,\theta)$  
$\omega$ 是我们提到的角频率，$\theta$ 是波矢量相对于风向的角度。

#### From Simulating Ocean Water : 4.3 Statistical Wave Models and the Fourier Transform

波浪谱有几种解析的经验模型，其中有一个风驱动模型，Phillips spectrum：  
$P_h(\vec{k})=A\frac{\exp(-1/(kL)^2)}{k^4}|\hat{\vec{k}}\cdot\hat{\vec{\omega}}|$  
其中 $L=V^2/g$ 为 <u>速度是 $V$ 的风可能产生的最大波</u>，$g$ 为重力常数，$\omega$ 为风的方向，$A$ 是一个数值常数。  
Phillips 的余弦系数 $|\hat{k}\cdot\hat{\omega}|$ 消除了垂直风向移动的波，模型简单，但是在波数 $|k|$ 较高时收敛性差，一种修复方式是抑制 长度$\mathscr{l}$( $\mathscr{l}\ll L$ ) 小的波，并通过乘因子 $\exp(-k^2\mathscr{l}^2)$ 修改 Phillips 

前面都是海洋高度公式，额，看不太明白……

还有水平偏移公式：  
$\vec{D}(\vec{x},t)=\sum_k-i\frac{\vec{k}}{k}\tilde{h}(\vec{k},t)e^{i\vec{k}\cdot\vec{x}}$  

和高度函数有些类似，把频谱改变一下，这个是的 $x$ 和 $z$ 总体描述，拆开得到 $x$ 和 $z$ 的单独描述
$$
\begin{aligned}
	D_x(\vec{x},t)=\textstyle\sum_k-i\frac{k_x}{k}\tilde{h}(\vec{k},t)e^{i\vec{k}\cdot\vec{x}}\\
	D_z(\vec{x},t)=\textstyle\sum_k-i\frac{k_z}{k}\tilde{h}(\vec{k},t)e^{i\vec{k}\cdot\vec{x}}\\
\end{aligned}
$$

## 公式的计算流程

![waveNV1](/imgs/水面模拟/waveNV1.png)

* 首先，根据公式生成 Phillips 频谱(↖)；
* 然后再计算两个相互独立服从均值为 0，标准差为 1的高斯函数。(↙)
* 之后根据公式结合完成了第一步，得到了一个初始的频谱  
  这里频谱计算一次即可，除非风 $L=V^2/g$​  会每帧变化，其他的随机数计算一次即可。

![waveNV2](/imgs/水面模拟/waveNV2.png)

* 得到初始频谱后，使用其计算 高度频谱 $\tilde{h}(\vec{k},t)$，$\tilde{H}(\vec{k})\rightarrow \tilde{H}(\vec{k},t)$
* 再使用高度函数就能得到 两个偏移频谱 $D_x(\vec{x},t)$ 和 $D_z(\vec{x},t)$，$\tilde{H}(\vec{k},t) \rightarrow D_x(\vec{x},t),D_z(\vec{x},t)$​

拿到频谱后，分别进行 IDFT， 就会得到水平 $x$、$z$ 以及高度 $y$ 的偏移图( $z$​ 为高度)。

将计算得到的图放在一起就能得到偏移纹理( Displacement )，再通过偏移纹理( Displacement ) 可以计算 法线 和 泡沫 贴图，这样我们所有的纹理就能够拿到了，然后进行渲染。

如果直接进行 IDFT 效率太低，

## FFT 推导

计算效率低的问题在哪？

先看一下海洋的公式
$$
\begin{aligned}
	h(\vec{x},t)=\textstyle\sum_k\tilde{h}(\vec{k},t)e^{i\vec{k}\cdot\vec{x}}
\end{aligned}
$$

这个是二维 IDFT，将 $h(\vec{x},t)$ 展开后得到
$$
\begin{aligned}
	&\vec{k}=(k_x,k_z)=(\frac{2\pi n}{L_x},\frac{2\pi m}{L_z})\\
	&\vec{x}=(x,z)\\
	&h(x,z,t)=\textstyle\sum^{\frac{M}{2}-1}_{m=-\frac{M}{2}}\sum^{\frac{N}{2}-1}_{m=-\frac{N}{2}}\tilde h(\frac{2\pi n}{L_x},\frac{2\pi m}{L_z},t)e^{i(\frac{2\pi n}{L_x}+\frac{2\pi m}{L_z})}
\end{aligned}
$$
这样的复杂度就是 一个位置的海面是 $O(NM)$，如果是所有位置大概就是 $O(N^2M^2)$

所以可以用 FFT 快速傅里叶变换的思想，进行快速傅里叶逆变换(IFFT)

为了推导先设(其实是为了把求和号归零吧)
$$
\begin{aligned}
&0\le n'\le N,n'\in(0,1,...,N-1)\\
&0\le m'\le M,m'\in(0,1,...,M-1)\\
&n=n'-\frac{N}{2}\\
&m=m'-\frac{M}{2}\\
&k_x=\frac{2\pi(n'-\frac{N}{2})}{L_x}=\frac{2\pi n'-\pi N}{L_x}\\
&k_z=\frac{2\pi(n'-\frac{M}{2})}{L_z}=\frac{2\pi m'-\pi M}{L_z}\\
\end{aligned}
$$
则，有
$$
\begin{aligned}
h'(x,z,t)=\textstyle\sum^{M-1}_{m'=0}\sum^{N-1}_{n'=0}\tilde{h}(n',m',t)
\end{aligned}
$$


# Unity 水面模拟

## 参考

[【学习笔记】Unity 基于GPU FFT海洋的实现-理论篇 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/95482541)  
[FFT海洋学习笔记（一） - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/335045713)  
[FFT海洋水体渲染学习笔记（二） - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/335946333)  
[傅里叶分析之掐死教程（完整版）更新于2014.06.06 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/19763358)  
[真实感水体渲染技术总结 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/95917609)  
[扩散（diffusion）和弥散（dispersion）有什么区别？ - 知乎 (zhihu.com)](https://www.zhihu.com/question/23914350)  
[Simulating Ocean Water-Jerry Tessendorf Paper - ResearchGate](https://www.researchgate.net/publication/264839743_Simulating_Ocean_Water/link/5ba8ecb0a6fdccd3cb6f6ffd/download?_tp=eyJjb250ZXh0Ijp7ImZpcnN0UGFnZSI6InB1YmxpY2F0aW9uIiwicGFnZSI6InB1YmxpY2F0aW9uIn19)  
[$\tanh$双曲正切函数（Tanh函数） - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/520861532)  
[OceanCS_Slides.pdf (nvidia.cn)](https://developer.download.nvidia.cn/assets/gamedev/files/sdk/11/OceanCS_Slides.pdf)

